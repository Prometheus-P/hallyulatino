---
import type { SearchResult } from '../../types/search';
import { contentTypeLabels } from '../../types/search';

interface Props {
  result: SearchResult;
  query: string;
}

const { result, query } = Astro.props;

// Highlight query terms in excerpt
function highlightExcerpt(excerpt: string, query: string): string {
  if (!query.trim()) return excerpt;
  const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
  return excerpt.replace(regex, '<mark class="bg-yellow-200 text-yellow-900 rounded px-0.5">$1</mark>');
}

// Format date in Spanish locale
const formattedDate = result.pubDate.toLocaleDateString('es-419', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Get content type badge color
const typeColors: Record<string, string> = {
  dramas: 'bg-pink-100 text-pink-800',
  kpop: 'bg-purple-100 text-purple-800',
  noticias: 'bg-blue-100 text-blue-800',
  guias: 'bg-teal-100 text-teal-800',
  all: 'bg-gray-100 text-gray-800',
};

const typeColor = typeColors[result.contentType] || typeColors.all;
const typeLabel = contentTypeLabels[result.contentType] || result.contentType;
---

<article class="search-result-card group" data-testid="search-result-card">
  <a href={result.url} class="block" style="border-radius: var(--md-sys-shape-corner-medium); border: 1px solid var(--md-sys-color-outline-variant); background-color: var(--md-sys-color-surface); padding: var(--md-sys-spacing-md); transition: all var(--md-sys-motion-duration-short4) var(--md-sys-motion-easing-standard);" onmouseover="this.style.borderColor='var(--md-sys-color-primary)'; this.style.boxShadow='var(--md-sys-elevation-level2)';" onmouseout="this.style.borderColor='var(--md-sys-color-outline-variant)'; this.style.boxShadow='none';">
    <div class="flex" style="gap: var(--md-sys-spacing-md);">
      {result.heroImage && (
        <div class="hidden sm:block flex-shrink-0">
          <img
            src={result.heroImage}
            alt=""
            class="h-24 w-24 object-cover"
            style="border-radius: var(--md-sys-shape-corner-medium);"
            loading="lazy"
            decoding="async"
          />
        </div>
      )}

      <div class="flex-1 min-w-0">
        <div class="flex items-center" style="gap: var(--md-sys-spacing-sm); margin-bottom: var(--md-sys-spacing-sm);">
          <span
            class={`inline-flex items-center text-xs font-medium ${typeColor}`}
            style="border-radius: var(--md-sys-shape-corner-full); padding: var(--md-sys-spacing-xs) calc(var(--md-sys-spacing-sm) + var(--md-sys-spacing-xs));"
            data-testid="result-type"
          >
            {typeLabel}
          </span>
        </div>

        <h3
          class="text-lg font-semibold line-clamp-2"
          style="color: var(--md-sys-color-on-surface);"
          data-testid="result-title"
        >
          {result.title}
        </h3>

        <p
          class="text-sm line-clamp-2"
          style="margin-top: var(--md-sys-spacing-xs); color: var(--md-sys-color-on-surface-variant);"
          data-testid="result-excerpt"
          set:html={highlightExcerpt(result.excerpt, query)}
        />

        <time
          datetime={result.pubDate.toISOString()}
          class="block text-xs"
          style="margin-top: var(--md-sys-spacing-sm); color: var(--md-sys-color-on-surface-variant); opacity: 0.7;"
          data-testid="result-date"
        >
          {formattedDate}
        </time>
      </div>
    </div>
  </a>
</article>
