---
import AdminLayout from '../../layouts/AdminLayout.astro';
import AdminGate from '../../components/admin/AdminGate.astro';
import FeatureForm from '../../components/admin/FeatureForm.astro';
import FeaturePreview from '../../components/admin/FeaturePreview.astro';
---

<AdminLayout title="Admin | Features" breadcrumbs={['Admin', 'Features']}>
  <AdminGate redirect="/admin/features">
    <div class="split">
      <FeatureForm />
      <FeaturePreview />
    </div>
    <div class="help card">
      <h4>Guía rápida para audiencia LatAm</h4>
      <ul>
        <li>Escribe en español y resalta contexto local (ciudades, comida, festivales).</li>
        <li>Añade al menos un gancho LatAm (tour stops, slang, fútbol, gastronomía).</li>
        <li>Incluye CTA localizado: "Descubre más en Latinoamérica".</li>
      </ul>
    </div>
  </AdminGate>
</AdminLayout>

<style>
  .split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    align-items: start;
  }
  .help {
    margin-top: 12px;
  }
  .card {
    background: #121a30;
    border: 1px solid #1f2a44;
    border-radius: 12px;
    padding: 16px;
  }
  ul {
    color: #c7d0e5;
  }
  @media (max-width: 1024px) {
    .split {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const form = document.getElementById('feature-form');
  const preview = {
    title: document.querySelector('[data-preview="title"]'),
    description: document.querySelector('[data-preview="description"]'),
    category: document.querySelector('[data-preview="category"]'),
    latamHook: document.querySelector('[data-preview="latamHook"]'),
    countries: document.querySelector('[data-preview="countries"]'),
    tags: document.querySelector('[data-preview="tags"]'),
    publishDate: document.querySelector('[data-preview="publishDate"]'),
    blocks: document.querySelector('[data-preview="blocks"]'),
    heroImage: document.querySelector('[data-preview="heroImage"]'),
  };

  const getField = (id) => (form?.querySelector(`#${id}`) as HTMLInputElement | HTMLTextAreaElement | null);

  const parseList = (value: string) =>
    value
      .split(',')
      .map((v) => v.trim())
      .filter(Boolean);

  const hydratePreview = () => {
    if (!form) return;
    const title = getField('title')?.value || 'Título de la nota';
    const description = getField('descriptionEs')?.value || 'Descripción en español para la audiencia latina.';
    const category = (getField('category') as HTMLSelectElement)?.value || 'Categoría';
    const countries = parseList(getField('countries')?.value || 'MX, CL').join(', ');
    const hooks = parseList(getField('latamHook')?.value || 'Engagement, Cultura');
    const tags = parseList(getField('tags')?.value || 'kpop, eventos').join(', ');
    const publishDate = getField('publishDate')?.value || '2024-12-03';
    const blocksValue = (getField('blocks') as HTMLTextAreaElement | null)?.value || '';

    if (preview.title) preview.title.textContent = title;
    if (preview.description) preview.description.textContent = description;
    if (preview.category) preview.category.textContent = category;
    if (preview.latamHook) preview.latamHook.textContent = hooks.join(' · ');
    if (preview.countries) preview.countries.textContent = countries;
    if (preview.tags) preview.tags.textContent = tags;
    if (preview.publishDate) preview.publishDate.textContent = publishDate;

    if (preview.blocks) {
      preview.blocks.innerHTML = '';
      if (!blocksValue.trim()) {
        preview.blocks.innerHTML = '<p>Agrega bloques para verlos aquí.</p>';
      } else {
        blocksValue.split('\n').forEach((line) => {
          const [heading, body] = line.split('::');
          const block = document.createElement('div');
          if (heading) {
            const h = document.createElement('h5');
            h.textContent = heading.trim();
            block.appendChild(h);
          }
          const p = document.createElement('p');
          p.textContent = (body || heading || '').trim();
          block.appendChild(p);
          preview.blocks?.appendChild(block);
        });
      }
    }
  };

  const exportMdx = () => {
    if (!form) return;
    const hooks = parseList(getField('latamHook')?.value || '');
    if (!hooks.length) {
      alert('Añade al menos un gancho LatAm antes de exportar.');
      return;
    }
    const payload = {
      title: getField('title')?.value || 'Nueva nota',
      descriptionEs: getField('descriptionEs')?.value || '',
      category: (getField('category') as HTMLSelectElement)?.value || 'culture',
      countries: parseList(getField('countries')?.value || ''),
      latamHook: hooks,
      heroImage: getField('heroImage')?.value || '',
      heroImageAlt: getField('heroImageAlt')?.value || '',
      publishDate: getField('publishDate')?.value || new Date().toISOString().slice(0, 10),
      author: getField('author')?.value || 'OndaCoreana',
      tags: parseList(getField('tags')?.value || ''),
      blocks:
        (getField('blocks') as HTMLTextAreaElement | null)?.value
          .split('\n')
          .filter(Boolean)
          .map((line) => {
            const [heading, body] = line.split('::');
            return { heading: heading?.trim(), body: (body || heading || '').trim() };
          }) || [],
      seoMeta: {
        title: (getField('seoTitle') as HTMLInputElement | null)?.value || undefined,
        description: (getField('seoDescription') as HTMLInputElement | null)?.value || undefined,
      },
    };

    const frontmatter = `---\n${Object.entries(payload)
      .map(([key, val]) => `${key}: ${JSON.stringify(val, null, 2).replace(/\"([^(\")"]+)\":/g, '$1:')}`)
      .join('\n')}\n---\n\n`;
    const body =
      payload.blocks
        ?.map((b) => {
          const heading = b.heading ? `## ${b.heading}\n` : '';
          return `${heading}${b.body}`;
        })
        .join('\n\n') || '';

    const blob = new Blob([frontmatter + body], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'feature-latam.mdx';
    a.click();
    URL.revokeObjectURL(url);
  };

  const handleAi = () => {
    alert('AI agent: conecta AI_AGENT_ENDPOINT para generar sugerencias.');
  };

  form?.addEventListener('input', hydratePreview);
  document.getElementById('export-mdx')?.addEventListener('click', exportMdx);
  document.getElementById('ai-generate')?.addEventListener('click', handleAi);
  hydratePreview();
</script>
